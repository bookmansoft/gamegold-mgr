# 调测随笔

## 自动登录问题

服务器断开、前端重新登录、前端页面刷新等状况下，尽可能自动恢复连接状态、停留在当前页面是一种好的用户体验。

在长连接时，页面刷新会导致WS失去连接，在重新连接时，建立长连是一个异步过程，这个过程如何与antd自身的页面刷新保持同步。
实践中通过阻塞 gamerpc.createSocket 直至连接重新建立方式解决，该功能封装于 gamerpc 组件内

服务端重启会导致前端页面断开，目前采用前端主动监控 disconnect 事件方式进行及时响应

Cookies 信息的设置和清理需要进一步优化，先前碰到的问题包括：
1. 重新建立长连时主动清理了Cookie，但导致了页面刷新时无法自动登录
2. 登录失败时的后续处理尚待优化，主要是没有很好的区分处理 验证失败、连接失败、网络异常 等不同情况。例如，登录失败时清理了Cookie，但由于没有区别对待各类情况，对页面刷新自动登录、关闭页面重开后自动登录造成了干扰。

目前就上述两种情况，并不主动清理Cookie，这部分需要进一步优化

服务端 token 失效后(两小时)，前端页面是否正确反应，Cookie处理是否配套，缺乏相关的状态控制代码

## 页面刷新后，超级管理员失去管理员权限

现象描述：
1. 超级管理员成功登录后，获得 ['admin', 'user'] 权限，可以正常访问'操作员管理'页面
2. 当页面刷新时，'操作员管理'相关菜单选项消失

原因解释：
1. 执行刷新操作时，执行 fetching('login.UserLogin') 进行登录操作，但该调用并未根据返回值设置 Cookies 和 sessionStorage
2. 由于前述流程上状态控制上的不完善，又导致页面刷新时缓存的 currentAuthority 被清除，从而虽然登录成功，但 currentAuthority 被默认重设为 ['admin']，导致失去管理员权限

解决方案：
1. 在 remoteRelogin 函数中，调用 fetching('login.UserLogin') 后，利用返回值手动重设 openid token currentAuthority 的数值，初步解决了上述问题
2. 后续优化时，可以采用有限状态机的机制，从整体上重构登录/重登流程中的状态管控

## 添加查看操作员余额、向操作员转账功能

1. 在操作员登录时，实时刷新其账户余额
2. 在接收到子账户变更通知时，刷新相关操作员账户余额。例如向操作员转账后会引发操作员余额变化
3. 系统管理员显示的账户余额，是 default 账户的余额，转账时使用的资金，也是 default 账户下的资金而非全部资金
